<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuantAlpha | 因子计算中台</title>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />

    <style>
        /* 弹窗圆角与阴影 */
        .custom-dialog {
            border-radius: 16px !important;
            overflow: hidden;
        }

        /* 表单间距优化 */
        .modern-form .el-form-item {
            margin-bottom: 22px;
        }

        .modern-form .el-form-item__label {
            font-weight: 600;
            color: #374151;
            padding-bottom: 8px !important;
        }

        /* 上传区域美化 */
        .modern-upload .el-upload-dragger {
            border: 2px dashed #e5e7eb;
            background: #f9fafb;
            padding: 20px !important;
            transition: all 0.3s ease;
        }

        .modern-upload .el-upload-dragger:hover {
            border-color: #2563eb;
            background: #f0f7ff;
        }

        /* 已选文件状态条 */
        .file-status-bar {
            display: flex;
            align-items: center;
            background: #eff6ff;
            padding: 8px 12px;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid #bfdbfe;
        }

        .file-name {
            flex: 1;
            margin: 0 10px;
            font-size: 13px;
            color: #1e40af;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 渐变按钮 */
        .glow-button {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%) !important;
            border: none !important;
            padding: 0 30px !important;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }

        .glow-button:hover {
            box-shadow: 0 6px 16px rgba(37, 99, 235, 0.4);
            transform: translateY(-1px);
        }

        :root {
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --primary-color: #2563eb;
            --text-main: #1f2937;
            --text-secondary: #6b7280;
            --border-radius: 12px;
            --shadow-soft: 0 10px 30px -10px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 20px 40px -10px rgba(0, 0, 0, 0.12);
        }

        body {
            background-color: var(--bg-color);
            margin: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            color: var(--text-main);
            -webkit-font-smoothing: antialiased;
        }

        [v-cloak] { display: none; } 

        .header-wrapper {
            background: linear-gradient(135deg, #111827 0%, #1f2937 100%);
            color: white;
            padding: 0 20px;
            height: 64px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            height: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .brand {
            font-weight: 600;
            font-size: 20px;
            display: flex;
            align-items: center;
            letter-spacing: -0.5px;
        }
        
        .brand span {
            background: linear-gradient(90deg, #60a5fa, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-left: 8px;
        }

        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .modern-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow-soft);
            transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0.5);
        }

        .modern-card:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px);
        }

        .el-table {
            --el-table-header-bg-color: #f9fafb;
            --el-table-header-text-color: #374151;
            --el-table-row-hover-bg-color: #eff6ff;
            border-radius: 8px;
            overflow: hidden;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin-right: 8px;
            position: relative;
        }

        .state-Running { background: #ecfdf5; color: #059669; border: 1px solid #a7f3d0; }
        .state-Running .dot { background: #10b981; }
        .state-Running .dot::after {
            content: '';
            position: absolute;
            top: -2px; left: -2px; right: -2px; bottom: -2px;
            border-radius: 50%;
            border: 2px solid #10b981;
            animation: pulse 1.5s infinite;
        }

        .state-Success { background: #eff6ff; color: #2563eb; border: 1px solid #bfdbfe; }
        .state-Success .dot { background: #3b82f6; }
        .state-Failed { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
        .state-Failed .dot { background: #ef4444; }
        .state-Idle { background: #f3f4f6; color: #6b7280; border: 1px solid #e5e7eb; }
        .state-Idle .dot { background: #9ca3af; }
        .state-Unknown { background: #fff7ed; color: #c2410c; border: 1px solid #fed7aa; }
        .state-Unknown .dot { background: #ea580c; }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.8; }
            70% { transform: scale(2.5); opacity: 0; }
            100% { transform: scale(1); opacity: 0; }
        }

        .log-container {
            background: #0d1117;
            border-radius: 8px;
            border: 1px solid #30363d;
            height: 500px;
            display: flex;
            flex-direction: column;
        }
        .log-header {
            background: #161b22;
            padding: 8px 15px;
            border-bottom: 1px solid #30363d;
            color: #8b949e;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
        }
        .log-content {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            color: #c9d1d9;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            white-space: pre-wrap;
        }
        
        .env-tag {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 2px 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="app" v-cloak>
        <div class="header-wrapper">
            <div class="header-content">
                <div class="brand">
                    <el-icon :size="24"><data-line></data-line></el-icon>
                    <span>QuantAlpha Engine</span>
                </div>
                <el-button type="primary" @click="dialogVisible = true" :icon="Plus">
                    新建计算任务
                </el-button>
            </div>
        </div>

        <div class="container">
            <el-row :gutter="20" style="margin-bottom: 24px;">
                <el-col :span="6">
                    <div class="modern-card" style="padding: 15px; display: flex; align-items: center;">
                        <div style="background: #eff6ff; padding: 10px; border-radius: 8px; color: #2563eb;">
                            <el-icon :size="20"><cpu></cpu></el-icon>
                        </div>
                        <div style="margin-left: 15px;">
                            <div style="color: #6b7280; font-size: 12px;">总任务数</div>
                            <div style="font-weight: 700; font-size: 20px;">{{ tasks.length }}</div>
                        </div>
                    </div>
                </el-col>
                <el-col :span="6">
                    <div class="modern-card" style="padding: 15px; display: flex; align-items: center;">
                        <div style="background: #ecfdf5; padding: 10px; border-radius: 8px; color: #059669;">
                            <el-icon :size="20"><timer></timer></el-icon>
                        </div>
                        <div style="margin-left: 15px;">
                            <div style="color: #6b7280; font-size: 12px;">运行中</div>
                            <div style="font-weight: 700; font-size: 20px;">
                                {{ tasks.filter(t => t.status === 'Running').length }}
                            </div>
                        </div>
                    </div>
                </el-col>
            </el-row>

            <div class="modern-card">
                <div style="margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between;">
                    <h3 style="margin: 0; font-weight: 600;">任务监控面板</h3>
                    <el-button circle plain @click="fetchTasks" size="small">
                        <el-icon><refresh></refresh></el-icon>
                    </el-button>
                </div>
                
                <el-table :data="tasks" style="width: 100%" v-loading="loading">
                    <el-table-column prop="name" label="任务名称" min-width="150">
                        <template #default="scope">
                            <span style="font-weight: 600; color: var(--text-main);">{{ scope.row.name }}</span>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">{{ scope.row.script }}</div>
                        </template>
                    </el-table-column>

                    <el-table-column label="环境配置" width="140">
                        <template #default="scope">
                            <span class="env-tag">conda: {{ scope.row.env }}</span>
                        </template>
                    </el-table-column>

                    <el-table-column label="调度策略" width="140">
                         <template #default="scope">
                            <div style="display: flex; align-items: center; color: var(--text-secondary);">
                                <el-icon style="margin-right: 4px;"><clock></clock></el-icon> 
                                <span>每天 {{ scope.row.schedule }}</span>
                            </div>
                        </template>
                    </el-table-column>

                    <el-table-column label="运行状态" width="140">
                        <template #default="scope">
                            <div class="status-badge" :class="'state-' + scope.row.status">
                                <span class="dot"></span>
                                {{ scope.row.status }}
                            </div>
                        </template>
                    </el-table-column>

                    <el-table-column prop="last_run" label="上次执行" width="180"></el-table-column>

                    <el-table-column label="操作" width="260" align="right">
                        <template #default="scope">
                            <el-button circle type="success" plain :icon="VideoPlay" @click="runNow(scope.row.id)" :loading="scope.row.status === 'Running'" title="立即运行"></el-button>
                            <el-button circle type="info" plain :icon="Document" @click="viewLogs(scope.row)" title="查看日志"></el-button>
                            <el-button circle type="danger" plain :icon="Delete" @click="deleteTask(scope.row)" title="删除任务"></el-button>
                        </template>
                    </el-table-column>
                </el-table>
            </div>
        </div>

        <el-dialog 
            v-model="dialogVisible" 
            title="配置因子计算任务" 
            width="540px" 
            append-to-body
            class="custom-dialog"
            destroy-on-close>
            
            <el-form :model="form" label-position="top" class="modern-form">
                <el-form-item label="任务识别名称" required>
                    <el-input v-model="form.name" placeholder="建议格式: 策略名_频率_版本 (e.g., Alpha101_Daily_V1)" size="large">
                        <template #prefix><el-icon><edit-pen /></el-icon></template>
                    </el-input>
                </el-form-item>
        
                <el-form-item label="数据依赖 (Pipeline)">
                    <el-select v-model="form.upstream_id" placeholder="选择此任务需要读取哪个任务的输出？" style="width: 100%" clearable size="large">
                        <template #prefix><el-icon><connection /></el-icon></template>
                        <el-option v-for="t in tasks" :key="t.id" :label="t.name" :value="t.id">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>{{ t.name }}</span>
                                <el-tag size="small" type="info" effect="plain">{{ t.env }}</el-tag>
                            </div>
                        </el-option>
                    </el-select>
                    <div style="font-size: 11px; color: #9ca3af; margin-top: 4px;">
                        * 选中后，脚本可通过 $UPSTREAM_OUTPUT_PATH 环境变量访问该任务的数据。
                    </div>
                </el-form-item>
        
                <el-form-item label="Python 算法脚本 (.py)" required>
                    <el-upload
                        class="modern-upload"
                        action="#" 
                        :auto-upload="false"
                        :on-change="handleFileChange"
                        :limit="1"
                        drag>
                        <el-icon class="el-icon--upload"><upload-filled /></el-icon>
                        <div class="el-upload__text">将算法文件拖到此处，或 <em>点击上传</em></div>
                    </el-upload>
                    <transition name="el-fade-in">
                        <div v-if="selectedFile" class="file-status-bar">
                            <el-icon color="#2563eb"><document /></el-icon>
                            <span class="file-name">{{ selectedFile.name }}</span>
                            <el-icon color="#059669"><circle-check-filled /></el-icon>
                        </div>
                    </transition>
                </el-form-item>
        
                <el-row :gutter="20">
                    <el-col :span="12">
                        <el-form-item label="运行环境">
                            <el-select v-model="form.env" placeholder="选择 Conda 环境" style="width: 100%" size="large">
                                <el-option v-for="item in envs" :key="item" :label="item" :value="item"></el-option>
                            </el-select>
                        </el-form-item>
                    </el-col>
                    <el-col :span="12">
                        <el-form-item label="每日触发时间">
                            <el-time-select 
                                v-model="form.time" 
                                start="00:00" 
                                step="00:15" 
                                end="23:45" 
                                placeholder="选择时间"
                                style="width: 100%"
                                size="large">
                            </el-time-select>
                        </el-form-item>
                    </el-col>
                </el-row>
            </el-form>
        
            <template #footer>
                <div class="dialog-footer">
                    <el-button @click="dialogVisible = false" size="large">取消</el-button>
                    <el-button type="primary" @click="createTask" size="large" class="glow-button">
                        部署因子任务
                    </el-button>
                </div>
            </template>
        </el-dialog>

        <el-dialog v-model="logVisible" :title="currentTaskName" width="850px">
            <div class="log-container">
                <div class="log-header">
                    <span>Terminal Output{{ currentLogDate ? ' · ' + currentLogDate : '' }}</span>
                    <span>Env: {{ currentEnv }}</span>
                </div>
                <div class="log-content">{{ logContent }}</div>
            </div>
        </el-dialog>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <script>
        const initApp = () => {
            const { createApp, ref, reactive, onMounted, onUnmounted } = Vue;
            const { Plus, VideoPlay, Document, Refresh, Delete } = ElementPlusIconsVue;

            const app = createApp({
                setup() {
                    const tasks = ref([]);
                    const envs = ref([]);
                    const loading = ref(false);
                    const dialogVisible = ref(false);
                    const logVisible = ref(false);
                    const selectedFile = ref(null);
                    
                    const currentTaskId = ref(null);
                    const currentTaskName = ref("");
                    const currentEnv = ref("");
                    const logContent = ref("");
                    const currentLogDate = ref("");

                    const form = reactive({ name: '', env: '', time: '', upstream_id: '' });

                    const fetchTasks = async (showLoading = true) => {
                        if (showLoading) loading.value = true;
                        const maxRetries = 5;
                        const baseDelay = 800;
                        for (let i = 0; i < maxRetries; i++) {
                            try {
                                const res = await axios.get('/api/tasks', { timeout: 10000 });
                                tasks.value = res.data;
                                break;
                            } catch (e) {
                                if (i === maxRetries - 1) {
                                    console.error(e);
                                    if (showLoading) ElementPlus.ElMessage.warning('列表加载失败，请稍后刷新');
                                } else {
                                    await new Promise(r => setTimeout(r, baseDelay * (i + 1)));
                                }
                            }
                        }
                        loading.value = false;
                    };

                    const fetchEnvs = async () => {
                        try {
                            const res = await axios.get('/api/envs');
                            envs.value = res.data;
                        } catch(e) { envs.value = ['base']; }
                    };

                    const handleFileChange = (file) => {
                        selectedFile.value = file.raw;
                    };

                    const createTask = async () => {
                        if(!form.name || !form.env || !form.time || !selectedFile.value) {
                            ElementPlus.ElMessage.warning('请完善任务信息、选择触发时间并上传脚本');
                            return;
                        }
                        const fd = new FormData();
                        fd.append('name', form.name);
                        fd.append('conda_env', form.env);
                        fd.append('time', form.time);
                        fd.append('file', selectedFile.value);
                        if (form.upstream_id) fd.append('upstream_id', form.upstream_id);

                        try {
                            await axios.post('/api/tasks', fd);
                            ElementPlus.ElMessage.success('创建成功');
                            dialogVisible.value = false;
                            selectedFile.value = null;
                            fetchTasks();
                        } catch(e) { ElementPlus.ElMessage.error('创建失败'); }
                    };

                    const runNow = async (id) => {
                        try {
                            await axios.post(`/api/run_now/${id}`);
                            fetchTasks(false);
                            ElementPlus.ElMessage.info('后台计算已触发');
                        } catch (e) {
                            ElementPlus.ElMessage.error(e?.response?.data?.detail || e?.response?.data?.message || '触发失败');
                            fetchTasks(false);
                        }
                    };

                    const deleteTask = async (row) => {
                        try {
                            await ElementPlus.ElMessageBox.confirm(
                                `确定要删除任务「${row.name}」吗？此操作将删除任务数据与日志，不可恢复。`,
                                '删除确认',
                                { type: 'warning', confirmButtonText: '删除', cancelButtonText: '取消' }
                            );
                            const res = await axios.delete(`/api/tasks/${row.id}`);
                            if (res.data.status === 'success') {
                                ElementPlus.ElMessage.success('已删除');
                                fetchTasks();
                            } else {
                                ElementPlus.ElMessage.error(res.data.message || '删除失败');
                            }
                        } catch (e) {
                            if (e !== 'cancel') ElementPlus.ElMessage.error(e?.response?.data?.detail || e?.response?.data?.message || '删除失败');
                        }
                    };

                    const viewLogs = async (row) => {
                        currentTaskId.value = row.id;
                        currentTaskName.value = row.name;
                        currentEnv.value = row.env;
                        logVisible.value = true;
                        fetchLog();
                    };

                    const fetchLog = async () => {
                        if(!currentTaskId.value) return;
                        logContent.value = "Loading...";
                        currentLogDate.value = "";
                        try {
                            const res = await axios.get(`/api/logs/${currentTaskId.value}`);
                            logContent.value = res.data.content;
                            currentLogDate.value = res.data.date || "";
                        } catch(e) { logContent.value = "暂无日志数据"; }
                    };

                    onMounted(() => {
                        fetchTasks();
                        fetchEnvs();
                        // SSE 推送：节流刷新（1 秒内最多一次），断线/空闲超时自动重连
                        let lastRefresh = 0;
                        let lastSSEMessageAt = Date.now();
                        const MIN_INTERVAL = 1000;
                        const SSE_IDLE_RECONNECT_MS = 35000;
                        let pendingRefresh = null;
                        let sseEv = null;
                        let sseIdleCheckTimer = null;
                        const doRefresh = () => {
                            if (!loading.value) {
                                fetchTasks(false);
                                lastRefresh = Date.now();
                            }
                        };
                        const onSSEMessage = () => {
                            lastSSEMessageAt = Date.now();
                            const now = Date.now();
                            if (now - lastRefresh >= MIN_INTERVAL) {
                                doRefresh();
                            } else if (!pendingRefresh) {
                                pendingRefresh = setTimeout(() => {
                                    doRefresh();
                                    pendingRefresh = null;
                                }, MIN_INTERVAL - (now - lastRefresh));
                            }
                        };
                        const connectSSE = () => {
                            if (sseEv) sseEv.close();
                            sseEv = new EventSource('/api/events');
                            lastSSEMessageAt = Date.now();
                            sseEv.onmessage = onSSEMessage;
                            sseEv.onerror = () => {
                                sseEv.close();
                                setTimeout(connectSSE, 2000);
                            };
                        };
                        connectSSE();
                        sseIdleCheckTimer = setInterval(() => {
                            if (sseEv && Date.now() - lastSSEMessageAt > SSE_IDLE_RECONNECT_MS) {
                                sseEv.close();
                                setTimeout(connectSSE, 1500);
                            }
                        }, 10000);
                        onUnmounted(() => {
                            if (sseIdleCheckTimer) clearInterval(sseIdleCheckTimer);
                            if (sseEv) sseEv.close();
                            if (pendingRefresh) clearTimeout(pendingRefresh);
                        });
                    });

                    return {
                        tasks, envs, loading, dialogVisible, logVisible, form, selectedFile,
                        currentTaskName, currentEnv, logContent, currentLogDate,
                        handleFileChange, createTask, runNow, viewLogs, fetchLog, fetchTasks,
                        Plus, VideoPlay, Document, Refresh, Delete,
                        deleteTask
                    };
                }
            });

            // 注册所有图标
            for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
                app.component(key, component);
            }
            
            app.use(ElementPlus);
            app.mount('#app');
        };

        window.onload = initApp;
    </script>
</body>
</html>