<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuantAlpha | 因子计算中台</title>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />

    <style>
        /* 弹窗圆角与阴影 */
        .custom-dialog {
            border-radius: 16px !important;
            overflow: hidden;
        }

        /* 表单间距优化 */
        .modern-form .el-form-item {
            margin-bottom: 22px;
        }

        .modern-form .el-form-item__label {
            font-weight: 600;
            color: #374151;
            padding-bottom: 8px !important;
        }

        /* 上传区域美化 */
        .modern-upload .el-upload-dragger {
            border: 2px dashed #e5e7eb;
            background: #f9fafb;
            padding: 20px !important;
            transition: all 0.3s ease;
        }

        .modern-upload .el-upload-dragger:hover {
            border-color: #2563eb;
            background: #f0f7ff;
        }

        /* 已选文件状态条 */
        .file-status-bar {
            display: flex;
            align-items: center;
            background: #eff6ff;
            padding: 8px 12px;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid #bfdbfe;
        }

        .file-name {
            flex: 1;
            margin: 0 10px;
            font-size: 13px;
            color: #1e40af;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 渐变按钮 */
        .glow-button {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%) !important;
            border: none !important;
            padding: 0 30px !important;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }

        .glow-button:hover {
            box-shadow: 0 6px 16px rgba(37, 99, 235, 0.4);
            transform: translateY(-1px);
        }

        :root {
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --primary-color: #2563eb;
            --text-main: #1f2937;
            --text-secondary: #6b7280;
            --border-radius: 12px;
            --shadow-soft: 0 10px 30px -10px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 20px 40px -10px rgba(0, 0, 0, 0.12);
        }

        body {
            background-color: var(--bg-color);
            margin: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            color: var(--text-main);
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
        }

        [v-cloak] { display: none; } 

        .header-wrapper {
            background: linear-gradient(135deg, #111827 0%, #1f2937 100%);
            color: white;
            padding: 0 20px;
            height: 64px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1440px;
            margin: 0 auto;
            height: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .brand {
            font-weight: 600;
            font-size: 20px;
            display: flex;
            align-items: center;
            letter-spacing: -0.5px;
        }
        
        .brand span {
            background: linear-gradient(90deg, #60a5fa, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-left: 8px;
        }

        .container {
            max-width: 1440px;
            width: min(1440px, 100%);
            margin: 30px auto;
            padding: 0 20px;
        }

        .modern-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow-soft);
            transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0.5);
        }

        .modern-card:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px);
        }

        .el-table {
            --el-table-header-bg-color: #f9fafb;
            --el-table-header-text-color: #374151;
            --el-table-row-hover-bg-color: #eff6ff;
            border-radius: 8px;
            overflow: hidden;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin-right: 8px;
            position: relative;
        }

        .state-Running { background: #ecfdf5; color: #059669; border: 1px solid #a7f3d0; }
        .state-Running .dot { background: #10b981; }
        .state-Running .dot::after {
            content: '';
            position: absolute;
            top: -2px; left: -2px; right: -2px; bottom: -2px;
            border-radius: 50%;
            border: 2px solid #10b981;
            animation: pulse 1.5s infinite;
        }

        .state-Success { background: #eff6ff; color: #2563eb; border: 1px solid #bfdbfe; }
        .state-Success .dot { background: #3b82f6; }
        .state-Failed { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
        .state-Failed .dot { background: #ef4444; }
        .state-Idle { background: #f3f4f6; color: #6b7280; border: 1px solid #e5e7eb; }
        .state-Idle .dot { background: #9ca3af; }
        .state-Unknown { background: #fff7ed; color: #c2410c; border: 1px solid #fed7aa; }
        .state-Unknown .dot { background: #ea580c; }
        .state-Stopped { background: #fefce8; color: #ca8a04; border: 1px solid #fde68a; }
        .state-Stopped .dot { background: #f59e0b; }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.8; }
            70% { transform: scale(2.5); opacity: 0; }
            100% { transform: scale(1); opacity: 0; }
        }

        .log-container {
            background: #0d1117;
            border-radius: 8px;
            border: 1px solid #30363d;
            height: 500px;
            display: flex;
            flex-direction: column;
        }
        .log-header {
            background: #161b22;
            padding: 8px 15px;
            border-bottom: 1px solid #30363d;
            color: #8b949e;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
        }
        .log-dialog {
            width: 900px;
            max-width: 90vw;
        }
        .log-content-wrap {
            flex: 1;
            min-height: 320px;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .log-content {
            flex: 1;
            min-height: 320px;
            padding: 15px;
            overflow-y: auto;
            color: #c9d1d9;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            white-space: pre-wrap;
        }
        .log-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 320px;
            color: #8b949e;
            font-size: 13px;
        }
        .log-error-msg {
            font-size: 12px;
            color: #f85149;
        }
        .log-status-badge {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 4px;
        }
        .log-status-live {
            background: rgba(35, 134, 54, 0.2);
            color: #3fb950;
        }
        .log-status-ended {
            background: rgba(110, 118, 129, 0.2);
            color: #8b949e;
        }
        .runs-panel {
            margin-bottom: 12px;
        }
        .runs-panel-toolbar {
            margin-bottom: 8px;
        }

        .runs-panel .el-table {
            --el-table-header-bg-color: #111827;
            --el-table-header-text-color: #e5e7eb;
            --el-table-row-hover-bg-color: #1f2937;
            background: #0f172a;
        }

        .run-log-button {
            font-size: 12px;
        }
        
        .env-tag {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 2px 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="app" v-cloak>
        <div class="header-wrapper">
            <div class="header-content">
                <div class="brand">
                    <el-icon :size="24"><data-line></data-line></el-icon>
                    <span>QuantAlpha Engine</span>
                </div>
                <el-button type="primary" @click="dialogVisible = true" :icon="Plus">
                    新建计算任务
                </el-button>
            </div>
        </div>

        <div class="container">
            <el-row :gutter="20" style="margin-bottom: 24px;">
                <el-col :span="6">
                    <div class="modern-card" style="padding: 15px; display: flex; align-items: center;">
                        <div style="background: #eff6ff; padding: 10px; border-radius: 8px; color: #2563eb;">
                            <el-icon :size="20"><cpu></cpu></el-icon>
                        </div>
                        <div style="margin-left: 15px;">
                            <div style="color: #6b7280; font-size: 12px;">总任务数</div>
                            <div style="font-weight: 700; font-size: 20px;">{{ tasks.length }}</div>
                        </div>
                    </div>
                </el-col>
                <el-col :span="6">
                    <div class="modern-card" style="padding: 15px; display: flex; align-items: center;">
                        <div style="background: #ecfdf5; padding: 10px; border-radius: 8px; color: #059669;">
                            <el-icon :size="20"><timer></timer></el-icon>
                        </div>
                        <div style="margin-left: 15px;">
                            <div style="color: #6b7280; font-size: 12px;">运行中</div>
                            <div style="font-weight: 700; font-size: 20px;">
                                {{ tasks.filter(t => t.status === 'Running').length }}
                            </div>
                        </div>
                    </div>
                </el-col>
            </el-row>

            <div class="modern-card">
                <div style="margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between;">
                    <h3 style="margin: 0; font-weight: 600;">任务监控面板</h3>
                    <el-button circle plain @click="fetchTasks" size="small">
                        <el-icon><refresh></refresh></el-icon>
                    </el-button>
                </div>
                
                <el-table :data="tasks" style="width: 100%" v-loading="loading">
                    <el-table-column prop="name" label="任务名称" min-width="150">
                        <template #default="scope">
                            <span style="font-weight: 600; color: var(--text-main);">{{ scope.row.name }}</span>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">{{ scope.row.script }}</div>
                        </template>
                    </el-table-column>

                    <el-table-column label="环境配置" width="140">
                        <template #default="scope">
                            <span class="env-tag">conda: {{ scope.row.env }}</span>
                        </template>
                    </el-table-column>

                    <el-table-column label="调度策略" width="140">
                         <template #default="scope">
                            <div style="display: flex; align-items: center; color: var(--text-secondary);">
                                <el-icon style="margin-right: 4px;"><clock></clock></el-icon> 
                                <span>每天 {{ scope.row.schedule }}</span>
                            </div>
                        </template>
                    </el-table-column>

                    <el-table-column label="任务类型" width="140">
                        <template #default="scope">
                            <el-tag size="small" :type="scope.row.task_type === 'market' ? 'success' : 'info'">
                                {{ scope.row.task_type === 'market' ? '行情更新' : '因子计算' }}
                            </el-tag>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                                非交易日{{ scope.row.run_on_non_trading ? '执行' : '不执行' }}
                            </div>
                        </template>
                    </el-table-column>

                    <el-table-column label="运行状态" width="140">
                        <template #default="scope">
                            <div class="status-badge" :class="'state-' + scope.row.status">
                                <span class="dot"></span>
                                {{ scope.row.status }}
                            </div>
                        </template>
                    </el-table-column>

                    <el-table-column label="执行时长" width="160">
                        <template #default="scope">
                            <span v-if="scope.row.status === 'Running'">
                                {{ formatDuration(getElapsedSeconds(scope.row)) }}
                            </span>
                            <span v-else>-</span>
                        </template>
                    </el-table-column>

                    <el-table-column prop="last_run" label="上次执行" width="180"></el-table-column>

                    <el-table-column label="操作" width="280" align="right">
                        <template #default="scope">
                            <el-button circle type="primary" plain @click="openTaskDetail(scope.row)" title="配置任务">
                                <el-icon><setting /></el-icon>
                            </el-button>
                            <el-button circle type="success" plain :icon="VideoPlay" @click="runNow(scope.row)" :loading="scope.row.status === 'Running'" title="立即运行"></el-button>
                            <el-button circle type="info" plain :icon="Document" @click="viewLogs(scope.row)" title="查看日志"></el-button>
                            <el-button circle type="danger" plain :icon="Delete" @click="deleteTask(scope.row)" title="删除任务"></el-button>
                        </template>
                    </el-table-column>
                </el-table>
            </div>

            <div class="modern-card" v-if="queueItems.length > 0" style="margin-top: 20px;">
                <div style="margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between;">
                    <h3 style="margin: 0; font-weight: 600;">任务队列</h3>
                    <el-button circle plain @click="fetchQueue" size="small">
                        <el-icon><refresh></refresh></el-icon>
                    </el-button>
                </div>
                <el-table :data="queueItems" size="small" v-loading="queueLoading" max-height="220">
                    <el-table-column prop="task_name" label="任务名称" min-width="140"></el-table-column>
                    <el-table-column prop="trigger_type" label="触发" width="80"></el-table-column>
                    <el-table-column prop="status" label="状态" width="100">
                        <template #default="scope">
                            <el-tag size="small" :type="scope.row.status === 'Running' ? 'success' : scope.row.status === 'Runnable' ? 'primary' : scope.row.status === 'Wait' ? 'warning' : 'info'">
                                {{ scope.row.status }}
                            </el-tag>
                        </template>
                    </el-table-column>
                    <el-table-column prop="run_date" label="运行日" width="110"></el-table-column>
                    <el-table-column prop="created_at" label="入队时间" width="170"></el-table-column>
                    <el-table-column label="操作" width="90" align="right">
                        <template #default="scope">
                            <el-button type="warning" plain size="small" :icon="CircleClose" @click="cancelQueueJob(scope.row)" title="终止">
                                终止
                            </el-button>
                        </template>
                    </el-table-column>
                </el-table>
            </div>
        </div>

        <el-dialog 
            v-model="dialogVisible" 
            title="配置任务" 
            width="540px" 
            append-to-body
            class="custom-dialog"
            destroy-on-close>
            
            <el-form :model="form" label-position="top" class="modern-form">
                <el-form-item label="任务识别名称" required>
                    <el-input v-model="form.name" placeholder="建议格式: 策略名_频率_版本 (e.g., Alpha101_Daily_V1)" size="large">
                        <template #prefix><el-icon><edit-pen /></el-icon></template>
                    </el-input>
                </el-form-item>
        
                <el-form-item label="数据依赖 (Pipeline)">
                    <el-select v-model="form.upstream_id" placeholder="选择此任务需要读取哪个任务的输出？" style="width: 100%" clearable size="large">
                        <template #prefix><el-icon><connection /></el-icon></template>
                        <el-option v-for="t in tasks" :key="t.id" :label="t.name" :value="t.id">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>{{ t.name }}</span>
                                <el-tag size="small" type="info" effect="plain">{{ t.env }}</el-tag>
                            </div>
                        </el-option>
                    </el-select>
                    <div style="font-size: 11px; color: #9ca3af; margin-top: 4px;">
                        * 选中后，脚本可通过 $UPSTREAM_TASK_DIR 环境变量访问上游任务目录；输出目录通过 $OUTPUT_PATH / $OUTPUT_DIR（任务的 output 目录）自由选择是否写入。
                    </div>
                </el-form-item>
        
                <el-form-item label="Python 算法脚本 (.py)" required>
                    <el-upload
                        class="modern-upload"
                        action="#" 
                        :auto-upload="false"
                        :on-change="handleFileChange"
                        :limit="1"
                        drag>
                        <el-icon class="el-icon--upload"><upload-filled /></el-icon>
                        <div class="el-upload__text">将算法文件拖到此处，或 <em>点击上传</em></div>
                    </el-upload>
                    <transition name="el-fade-in">
                        <div v-if="selectedFile" class="file-status-bar">
                            <el-icon color="#2563eb"><document /></el-icon>
                            <span class="file-name">{{ selectedFile.name }}</span>
                            <el-icon color="#059669"><circle-check-filled /></el-icon>
                        </div>
                    </transition>
                </el-form-item>
        
                <el-row :gutter="20">
                    <el-col :span="12">
                        <el-form-item label="运行环境">
                            <el-select v-model="form.env" placeholder="选择 Conda 环境" style="width: 100%" size="large">
                                <el-option v-for="item in envs" :key="item" :label="item" :value="item"></el-option>
                            </el-select>
                        </el-form-item>
                    </el-col>
                    <el-col :span="12">
                        <el-form-item label="每日触发时间">
                            <el-time-select 
                                v-model="form.time" 
                                start="00:00" 
                                step="00:15" 
                                end="23:45" 
                                placeholder="选择时间"
                                style="width: 100%"
                                size="large">
                            </el-time-select>
                        </el-form-item>
                    </el-col>
                </el-row>
                <el-row :gutter="20">
                    <el-col :span="12">
                        <el-form-item label="任务类型">
                            <el-select v-model="form.task_type" placeholder="选择任务类型" style="width: 100%" size="large">
                                <el-option label="行情更新任务" value="market"></el-option>
                                <el-option label="因子计算任务" value="factor"></el-option>
                            </el-select>
                        </el-form-item>
                    </el-col>
                    <el-col :span="12">
                        <el-form-item label="非交易日执行">
                            <el-switch
                                v-model="form.run_on_non_trading"
                                active-text="执行"
                                inactive-text="不执行"
                                size="large" />
                        </el-form-item>
                    </el-col>
                </el-row>
            </el-form>
        
            <template #footer>
                <div class="dialog-footer">
                    <el-button @click="dialogVisible = false" size="large">取消</el-button>
                    <el-button type="primary" @click="createTask" size="large" class="glow-button">
                        部署任务
                    </el-button>
                </div>
            </template>
        </el-dialog>

        <el-dialog v-model="logVisible" :title="currentTaskName" class="log-dialog" @close="stopLogTail">
            <div class="runs-panel">
                <div class="runs-panel-toolbar">
                    <el-button size="small" @click="refreshRunsAndMaybeSwitch()">刷新运行列表</el-button>
                </div>
                <el-table :data="runs" height="200" size="small" v-loading="runsLoading">
                    <el-table-column prop="start_time" label="开始时间" width="170"></el-table-column>
                    <el-table-column prop="status" label="状态" width="110"></el-table-column>
                    <el-table-column prop="duration" label="耗时(s)" width="100">
                        <template #default="scope">
                            {{ scope.row.duration ? scope.row.duration.toFixed(2) : '-' }}
                        </template>
                    </el-table-column>
                    <el-table-column prop="exit_code" label="退出码" width="80"></el-table-column>
                    <el-table-column prop="log_path" label="日志路径"></el-table-column>
                    <el-table-column label="操作" width="110">
                        <template #default="scope">
                            <el-button type="primary" text class="run-log-button" @click="fetchLogForRun(scope.row)">
                                查看日志
                            </el-button>
                        </template>
                    </el-table-column>
                </el-table>
            </div>
            <div class="log-container">
                <div class="log-header">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span>Terminal Output</span>
                        <el-select
                            v-model="currentRunId"
                            size="small"
                            placeholder="选择运行记录"
                            style="min-width: 240px;"
                            @change="fetchLog">
                            <el-option
                                v-for="run in runs"
                                :key="run.id"
                                :label="`${run.started_at || run.id} (${run.status})`"
                                :value="run.id">
                            </el-option>
                        </el-select>
                        <span v-if="currentRunStatus === 'Running'" class="log-status-badge log-status-live">实时</span>
                        <span v-else-if="currentRunStatus" class="log-status-badge log-status-ended">已结束</span>
                    </div>
                    <span>Env: {{ currentEnv }}</span>
                </div>
                <div class="log-content-wrap" v-loading="logLoading">
                    <template v-if="logError">
                        <div class="log-placeholder">
                            <span>加载失败</span>
                            <span v-if="logErrorMessage" class="log-error-msg">{{ logErrorMessage }}</span>
                            <el-button type="primary" size="small" @click="logError = false; fetchLog()">重试</el-button>
                        </div>
                    </template>
                    <template v-else-if="!logContent && !logLoading">
                        <div class="log-placeholder">暂无日志</div>
                    </template>
                    <div v-else ref="logContentEl" class="log-content">{{ logContent }}</div>
                </div>
            </div>
        </el-dialog>

        <el-dialog 
            v-model="editDialogVisible" 
            title="任务详情 / 编辑配置" 
            width="560px"
            append-to-body
            class="custom-dialog"
            destroy-on-close>
            <div style="margin-bottom: 16px; padding: 12px 14px; background:#f9fafb; border-radius: 10px; border:1px solid #e5e7eb;">
                <div style="font-size:14px; font-weight:600; color:#111827; margin-bottom:6px;">
                    {{ editForm.name || '未命名任务' }}
                </div>
                <div style="display:flex; flex-wrap:wrap; gap:8px; font-size:12px; color:#6b7280;">
                    <span>脚本: {{ editForm.script || '-' }}</span>
                    <span>环境: {{ editForm.env || '-' }}</span>
                    <span>调度: 每天 {{ editForm.time || editForm.schedule || '-' }}</span>
                </div>
            </div>

            <el-form :model="editForm" label-position="top" class="modern-form">
                <el-form-item label="任务识别名称" required>
                    <el-input v-model="editForm.name" placeholder="任务名称" size="large">
                        <template #prefix><el-icon><edit-pen /></el-icon></template>
                    </el-input>
                </el-form-item>

                <el-form-item label="数据依赖 (Pipeline)">
                    <el-select v-model="editForm.upstream_id" placeholder="选择此任务需要读取哪个任务的输出？" style="width: 100%" clearable size="large">
                        <template #prefix><el-icon><connection /></el-icon></template>
                        <el-option v-for="t in tasks" :key="t.id" :label="t.name" :value="t.id">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>{{ t.name }}</span>
                                <el-tag size="small" type="info" effect="plain">{{ t.env }}</el-tag>
                            </div>
                        </el-option>
                    </el-select>
                    <div style="font-size: 11px; color: #9ca3af; margin-top: 4px;">
                        * 选中后，脚本可通过 $UPSTREAM_TASK_DIR 访问上游任务目录。
                    </div>
                </el-form-item>

                <el-row :gutter="20">
                    <el-col :span="12">
                        <el-form-item label="运行环境">
                            <el-select v-model="editForm.env" placeholder="选择 Conda 环境" style="width: 100%" size="large">
                                <el-option v-for="item in envs" :key="item" :label="item" :value="item"></el-option>
                            </el-select>
                        </el-form-item>
                    </el-col>
                    <el-col :span="12">
                        <el-form-item label="每日触发时间">
                            <el-time-select 
                                v-model="editForm.time" 
                                start="00:00" 
                                step="00:15" 
                                end="23:45" 
                                placeholder="选择时间"
                                style="width: 100%"
                                size="large">
                            </el-time-select>
                        </el-form-item>
                    </el-col>
                </el-row>
                <el-row :gutter="20">
                    <el-col :span="12">
                        <el-form-item label="任务类型">
                            <el-select v-model="editForm.task_type" placeholder="选择任务类型" style="width: 100%" size="large">
                                <el-option label="行情更新任务" value="market"></el-option>
                                <el-option label="因子计算任务" value="factor"></el-option>
                            </el-select>
                        </el-form-item>
                    </el-col>
                    <el-col :span="12">
                        <el-form-item label="非交易日执行">
                            <el-switch
                                v-model="editForm.run_on_non_trading"
                                active-text="执行"
                                inactive-text="不执行"
                                size="large" />
                        </el-form-item>
                    </el-col>
                </el-row>
            </el-form>

            <template #footer>
                <div class="dialog-footer">
                    <el-button @click="editDialogVisible = false" size="large">取消</el-button>
                    <el-button type="primary" @click="saveTaskConfig" size="large" class="glow-button">
                        保存配置
                    </el-button>
                </div>
            </template>
        </el-dialog>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <script>
        const initApp = () => {
            const { createApp, ref, reactive, computed, nextTick, onMounted, onUnmounted } = Vue;
            const { Plus, VideoPlay, Document, Refresh, Delete, CircleClose } = ElementPlusIconsVue;

            const app = createApp({
                setup() {
                    const tasks = ref([]);
                    const envs = ref([]);
                    const loading = ref(false);
                    const dialogVisible = ref(false);
                    const logVisible = ref(false);
                    const selectedFile = ref(null);
                    const runs = ref([]);
                    const runsLoading = ref(false);
                    const queueItems = ref([]);
                    const queueLoading = ref(false);
                    
                    const currentTaskId = ref(null);
                    const currentTaskName = ref("");
                    const currentEnv = ref("");
                    const logContent = ref("");
                    const logLoading = ref(false);
                    const logError = ref(false);
                    const logErrorMessage = ref("");
                    const logContentEl = ref(null);
                    const currentRunId = ref("");
                    const logTailOffset = ref(0);
                    const logTailTimer = ref(null);
                    const nowTick = ref(Date.now());

                    const currentRunStatus = computed(() => {
                        if (!currentRunId.value || !runs.value.length) return null;
                        const r = runs.value.find(x => (x.id || x.run_id) === currentRunId.value);
                        return r ? r.status : null;
                    });

                    const form = reactive({
                        name: '',
                        env: '',
                        time: '',
                        upstream_id: '',
                        task_type: 'factor',
                        run_on_non_trading: false,
                    });

                    const editDialogVisible = ref(false);
                    const editingTaskId = ref(null);
                    const editForm = reactive({
                        id: '',
                        name: '',
                        script: '',
                        env: '',
                        time: '',
                        schedule: '',
                        upstream_id: '',
                        task_type: 'factor',
                        run_on_non_trading: false,
                    });

                    const fetchTasks = async (showLoading = true) => {
                        if (showLoading) loading.value = true;
                        const maxRetries = 5;
                        const baseDelay = 800;
                        for (let i = 0; i < maxRetries; i++) {
                            try {
                                const res = await axios.get('/api/tasks', { timeout: 10000 });
                                tasks.value = res.data;
                                break;
                            } catch (e) {
                                if (i === maxRetries - 1) {
                                    console.error(e);
                                    if (showLoading) ElementPlus.ElMessage.warning('列表加载失败，请稍后刷新');
                                } else {
                                    await new Promise(r => setTimeout(r, baseDelay * (i + 1)));
                                }
                            }
                        }
                        loading.value = false;
                    };

                    const fetchEnvs = async () => {
                        try {
                            const res = await axios.get('/api/envs');
                            envs.value = res.data;
                        } catch(e) { envs.value = ['base']; }
                    };

                    const fetchQueue = async () => {
                        queueLoading.value = true;
                        try {
                            const res = await axios.get('/api/queue', { params: { limit: 100 } });
                            queueItems.value = res.data || [];
                        } catch (e) {
                            queueItems.value = [];
                        } finally {
                            queueLoading.value = false;
                        }
                    };

                    const handleFileChange = (file) => {
                        selectedFile.value = file.raw;
                    };

                    const createTask = async () => {
                        if(!form.name || !form.env || !form.time || !form.task_type || !selectedFile.value) {
                            ElementPlus.ElMessage.warning('请完善任务信息、选择触发时间并上传脚本');
                            return;
                        }
                        const fd = new FormData();
                        fd.append('name', form.name);
                        fd.append('conda_env', form.env);
                        fd.append('time', form.time);
                        fd.append('task_type', form.task_type);
                        fd.append('run_on_non_trading', form.run_on_non_trading ? 'true' : 'false');
                        fd.append('file', selectedFile.value);
                        if (form.upstream_id) fd.append('upstream_id', form.upstream_id);

                        try {
                            await axios.post('/api/tasks', fd);
                            ElementPlus.ElMessage.success('创建成功');
                            dialogVisible.value = false;
                            selectedFile.value = null;
                            fetchTasks();
                        } catch(e) { ElementPlus.ElMessage.error('创建失败'); }
                    };

                    const esc = (s) => { if (s == null || s === undefined) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); };
                    const runNow = async (row) => {
                        try {
                            const msg = '<div style="line-height:1.75;color:#374151;">' +
                                '<p style="margin:0 0 12px 0;font-size:13px;color:#6b7280;">确认后任务将加入队列，并按依赖顺序执行。</p>' +
                                '<div style="margin-top:12px;padding-top:12px;border-top:1px solid #e5e7eb;">' +
                                '<div style="margin-bottom:8px;"><strong style="font-size:12px;color:#9ca3af;">任务名称</strong><br/><span style="font-size:14px;">' + esc(row.name) + '</span></div>' +
                                '<div style="margin-bottom:8px;"><strong style="font-size:12px;color:#9ca3af;">脚本</strong><br/><span style="font-size:14px;">' + esc(row.script || '-') + '</span></div>' +
                                '<div style="margin-bottom:8px;"><strong style="font-size:12px;color:#9ca3af;">环境</strong><br/><span style="font-size:14px;">' + esc(row.env || '-') + '</span></div>' +
                                '<div style="margin-bottom:0;"><strong style="font-size:12px;color:#9ca3af;">调度</strong><br/><span style="font-size:14px;">每天 ' + esc(row.schedule || '-') + '</span></div>' +
                                '</div></div>';
                            await ElementPlus.ElMessageBox.confirm(
                                msg,
                                '立即运行确认',
                                { type: 'info', confirmButtonText: '立即运行', cancelButtonText: '取消', dangerouslyUseHTMLString: true }
                            );
                            const res = await axios.post(`/api/run_now/${row.id}`);
                            fetchTasks(false);
                            if (res.data?.status === 'queued') {
                                ElementPlus.ElMessage.success('已加入队列');
                            } else {
                                ElementPlus.ElMessage.info('已提交');
                            }
                            fetchQueue();
                        } catch (e) {
                            if (e !== 'cancel') {
                                ElementPlus.ElMessage.error(e?.response?.data?.detail || e?.response?.data?.message || '触发失败');
                                fetchTasks(false);
                            }
                        }
                    };

                    const deleteTask = async (row) => {
                        try {
                            await ElementPlus.ElMessageBox.confirm(
                                `确定要删除任务「${row.name}」吗？此操作将删除任务数据与日志，不可恢复。`,
                                '删除确认',
                                { type: 'warning', confirmButtonText: '删除', cancelButtonText: '取消' }
                            );
                            const res = await axios.delete(`/api/tasks/${row.id}`);
                            if (res.data.status === 'success') {
                                ElementPlus.ElMessage.success('已删除');
                                fetchTasks();
                            } else {
                                ElementPlus.ElMessage.error(res.data.message || '删除失败');
                            }
                        } catch (e) {
                            if (e !== 'cancel') ElementPlus.ElMessage.error(e?.response?.data?.detail || e?.response?.data?.message || '删除失败');
                        }
                    };

                    const viewLogs = async (row) => {
                        currentTaskId.value = row.id;
                        currentTaskName.value = row.name;
                        currentEnv.value = row.env;
                        logVisible.value = true;
                        await fetchRuns();
                        fetchLog();
                    };

                    const fetchRuns = async () => {
                        if (!currentTaskId.value) return;
                        runsLoading.value = true;
                        try {
                            const prevRunId = currentRunId.value;
                            const res = await axios.get(`/api/tasks/${currentTaskId.value}/runs`, { params: { limit: 20 } });
                            runs.value = res.data || [];
                            // 默认行为：如果当前选中的 run 仍然存在，则保持不变；否则退回到最新一条
                            if (prevRunId && runs.value.some(r => (r.id || r.run_id) === prevRunId)) {
                                currentRunId.value = prevRunId;
                            } else {
                                currentRunId.value = runs.value.length ? (runs.value[0].id || runs.value[0].run_id) : "";
                            }
                        } catch (e) {
                            runs.value = [];
                            currentRunId.value = "";
                        } finally {
                            runsLoading.value = false;
                        }
                    };

                    const refreshRunsAndMaybeSwitch = async () => {
                        const oldFirstId = runs.value.length ? (runs.value[0].id || runs.value[0].run_id) : null;
                        await fetchRuns();
                        const newFirstId = runs.value.length ? (runs.value[0].id || runs.value[0].run_id) : null;
                        // 若出现新的 run（最新一条发生变化），切换到最新 run 并重拉日志
                        if (newFirstId && newFirstId !== oldFirstId) {
                            currentRunId.value = newFirstId;
                            fetchLog();
                        }
                    };

                    const fetchLogForRun = (run) => {
                        currentRunId.value = run.id || run.run_id;
                        fetchLog();
                    };

                    const fetchLog = async () => {
                        if(!currentTaskId.value) return;
                        logContent.value = "";
                        logTailOffset.value = 0;
                        logError.value = false;
                        logErrorMessage.value = "";
                        stopLogTail();
                        logLoading.value = true;
                        try {
                            await fetchLogTailOnce();
                            startLogTail();
                        } finally {
                            logLoading.value = false;
                        }
                    };

                    const fetchLogTailOnce = async () => {
                        if (!currentTaskId.value) return;
                        try {
                            logError.value = false;
                            logErrorMessage.value = "";
                            const config = {
                                params: {
                                    run_id: currentRunId.value || undefined,
                                    offset: logTailOffset.value || 0,
                                    max_bytes: 65536,
                                },
                            };
                            const res = await axios.get(`/api/logs_tail/${currentTaskId.value}`, config);
                            const payload = res.data || {};
                            if (payload.data) {
                                logContent.value += payload.data;
                                const runStatus = runs.value.find(r => (r.id || r.run_id) === currentRunId.value)?.status;
                                if (runStatus === 'Running') {
                                    nextTick(() => {
                                        if (logContentEl.value) logContentEl.value.scrollTop = logContentEl.value.scrollHeight;
                                    });
                                }
                            }
                            if (typeof payload.offset === 'number') {
                                logTailOffset.value = payload.offset;
                            }
                            if (payload.run_id && !currentRunId.value) {
                                currentRunId.value = payload.run_id;
                            }
                        } catch (e) {
                            logError.value = true;
                            logErrorMessage.value = e?.response?.data?.detail || e?.message || "加载失败";
                            if (!logContent.value) logContent.value = "";
                        }
                    };

                    const startLogTail = () => {
                        if (logTailTimer.value) return;
                        logTailTimer.value = setInterval(() => {
                            fetchLogTailOnce();
                        }, 1000);
                    };

                    const stopLogTail = () => {
                        if (logTailTimer.value) {
                            clearInterval(logTailTimer.value);
                            logTailTimer.value = null;
                        }
                    };

                    const getElapsedSeconds = (row) => {
                        if (!row.last_run_ts) return 0;
                        const start = Date.parse(row.last_run_ts);
                        if (Number.isNaN(start)) return 0;
                        return Math.max(0, Math.floor((nowTick.value - start) / 1000));
                    };

                    const formatDuration = (totalSeconds) => {
                        const hours = Math.floor(totalSeconds / 3600);
                        const minutes = Math.floor((totalSeconds % 3600) / 60);
                        const seconds = totalSeconds % 60;
                        if (hours > 0) {
                            return `${hours}h ${minutes}m ${seconds}s`;
                        }
                        if (minutes > 0) {
                            return `${minutes}m ${seconds}s`;
                        }
                        return `${seconds}s`;
                    };

                    const stopTask = async (row) => {
                        try {
                            await ElementPlus.ElMessageBox.confirm(
                                `确认强制终止任务「${row.name}」吗？该操作会直接终止进程。`,
                                '终止确认',
                                { type: 'warning', confirmButtonText: '终止', cancelButtonText: '取消' }
                            );
                            await axios.post(`/api/stop/${row.id}`);
                            ElementPlus.ElMessage.success('任务已终止');
                            fetchTasks(false);
                        } catch (e) {
                            if (e !== 'cancel') {
                                ElementPlus.ElMessage.error(e?.response?.data?.detail || e?.response?.data?.message || '终止失败');
                            }
                        }
                    };

                    const cancelQueueJob = async (row) => {
                        try {
                            const statusTip = row.status === 'Running' ? '当前正在执行，确认后将终止进程。' : '尚未执行，确认将从队列中移除。';
                            const msg = '<div style="line-height:1.75;color:#374151;">' +
                                '<p style="margin:0 0 12px 0;font-size:13px;color:#6b7280;">' + esc(statusTip) + '</p>' +
                                '<div style="margin-top:12px;padding-top:12px;border-top:1px solid #e5e7eb;">' +
                                '<div style="margin-bottom:8px;"><strong style="font-size:12px;color:#9ca3af;">任务名称</strong><br/><span style="font-size:14px;">' + esc(row.task_name || '-') + '</span></div>' +
                                '<div style="margin-bottom:8px;"><strong style="font-size:12px;color:#9ca3af;">触发方式</strong><br/><span style="font-size:14px;">' + esc(row.trigger_type || '-') + '</span></div>' +
                                '<div style="margin-bottom:8px;"><strong style="font-size:12px;color:#9ca3af;">状态</strong><br/><span style="font-size:14px;">' + esc(row.status || '-') + '</span></div>' +
                                '<div style="margin-bottom:8px;"><strong style="font-size:12px;color:#9ca3af;">运行日</strong><br/><span style="font-size:14px;">' + esc(row.run_date || '-') + '</span></div>' +
                                '<div style="margin-bottom:0;"><strong style="font-size:12px;color:#9ca3af;">入队时间</strong><br/><span style="font-size:14px;">' + esc(row.created_at || '-') + '</span></div>' +
                                '</div></div>';
                            await ElementPlus.ElMessageBox.confirm(
                                msg,
                                '终止确认',
                                { type: 'warning', confirmButtonText: '终止', cancelButtonText: '取消', dangerouslyUseHTMLString: true }
                            );
                            const res = await axios.post(`/api/queue/${row.id}/cancel`);
                            if (res.data?.status === 'cancelled') {
                                ElementPlus.ElMessage.success('已从队列移除');
                            } else if (res.data?.status === 'stopped') {
                                ElementPlus.ElMessage.success('任务已终止');
                            }
                            fetchQueue();
                            fetchTasks(false);
                        } catch (e) {
                            if (e !== 'cancel') {
                                ElementPlus.ElMessage.error(e?.response?.data?.detail || e?.response?.data?.message || '操作失败');
                                fetchQueue();
                            }
                        }
                    };

                    const openTaskDetail = async (row) => {
                        try {
                            const res = await axios.get(`/api/tasks/${row.id}`);
                            const task = res.data;
                            editingTaskId.value = task.id;
                            editForm.id = task.id;
                            editForm.name = task.name || '';
                            editForm.script = task.script || '';
                            editForm.env = task.env || '';
                            editForm.time = task.time || task.schedule || '';
                            editForm.schedule = task.schedule || task.time || '';
                            editForm.upstream_id = task.upstream_id || '';
                            editForm.task_type = task.task_type || 'factor';
                            editForm.run_on_non_trading = !!task.run_on_non_trading;
                            editDialogVisible.value = true;
                        } catch (e) {
                            ElementPlus.ElMessage.error(e?.response?.data?.detail || '获取任务详情失败');
                        }
                    };

                    const saveTaskConfig = async () => {
                        if (!editingTaskId.value) {
                            ElementPlus.ElMessage.error('未选择任务');
                            return;
                        }
                        if (!editForm.name || !editForm.env || !editForm.time || !editForm.task_type) {
                            ElementPlus.ElMessage.warning('请完善任务名称、运行环境、触发时间和任务类型');
                            return;
                        }
                        const fd = new FormData();
                        fd.append('name', editForm.name);
                        fd.append('conda_env', editForm.env);
                        fd.append('time', editForm.time);
                        fd.append('task_type', editForm.task_type);
                        fd.append('run_on_non_trading', editForm.run_on_non_trading ? 'true' : 'false');
                        if (editForm.upstream_id) {
                            fd.append('upstream_id', editForm.upstream_id);
                        }
                        try {
                            await axios.put(`/api/tasks/${editingTaskId.value}`, fd);
                            ElementPlus.ElMessage.success('配置已保存');
                            editDialogVisible.value = false;
                            fetchTasks(false);
                        } catch (e) {
                            ElementPlus.ElMessage.error(e?.response?.data?.detail || '保存失败');
                        }
                    };

                    onMounted(() => {
                        fetchTasks();
                        fetchEnvs();
                        fetchQueue();
                        // SSE 推送：节流刷新（1 秒内最多一次），断线/空闲超时自动重连
                        let lastRefresh = 0;
                        let lastSSEMessageAt = Date.now();
                        const MIN_INTERVAL = 1000;
                        const SSE_IDLE_RECONNECT_MS = 35000;
                        let pendingRefresh = null;
                        let sseEv = null;
                        let sseIdleCheckTimer = null;
                        const doRefresh = () => {
                            if (!loading.value) {
                                fetchTasks(false);
                                fetchQueue();
                                lastRefresh = Date.now();
                            }
                        };
                        const onSSEMessage = () => {
                            lastSSEMessageAt = Date.now();
                            const now = Date.now();
                            if (now - lastRefresh >= MIN_INTERVAL) {
                                doRefresh();
                            } else if (!pendingRefresh) {
                                pendingRefresh = setTimeout(() => {
                                    doRefresh();
                                    pendingRefresh = null;
                                }, MIN_INTERVAL - (now - lastRefresh));
                            }
                        };
                        const connectSSE = () => {
                            if (sseEv) sseEv.close();
                            sseEv = new EventSource('/api/events');
                            lastSSEMessageAt = Date.now();
                            sseEv.onmessage = onSSEMessage;
                            sseEv.onerror = () => {
                                sseEv.close();
                                setTimeout(connectSSE, 2000);
                            };
                        };
                        connectSSE();
                        sseIdleCheckTimer = setInterval(() => {
                            if (sseEv && Date.now() - lastSSEMessageAt > SSE_IDLE_RECONNECT_MS) {
                                sseEv.close();
                                setTimeout(connectSSE, 1500);
                            }
                        }, 10000);
                        const timer = setInterval(() => {
                            nowTick.value = Date.now();
                        }, 1000);
                        onUnmounted(() => {
                            if (sseIdleCheckTimer) clearInterval(sseIdleCheckTimer);
                            if (sseEv) sseEv.close();
                            if (pendingRefresh) clearTimeout(pendingRefresh);
                            clearInterval(timer);
                            stopLogTail();
                        });
                    });

                    return {
                        tasks, envs, loading, dialogVisible, logVisible, form, selectedFile,
                        runs, runsLoading, queueItems, queueLoading, fetchQueue,
                        currentTaskName, currentEnv, logContent, logLoading, logError, logErrorMessage,
                        logContentEl, currentRunStatus, currentRunId, nowTick,
                        handleFileChange, createTask, runNow, viewLogs, fetchLog, fetchRuns, refreshRunsAndMaybeSwitch, fetchTasks,
                        getElapsedSeconds, formatDuration, stopTask, cancelQueueJob,
                        editDialogVisible, editForm, openTaskDetail, saveTaskConfig,
                        Plus, VideoPlay, Document, Refresh, Delete, CircleClose,
                        deleteTask, stopLogTail
                    };
                }
            });

            // 注册所有图标
            for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
                app.component(key, component);
            }
            
            app.use(ElementPlus);
            app.mount('#app');
        };

        window.onload = initApp;
    </script>
</body>
</html>
